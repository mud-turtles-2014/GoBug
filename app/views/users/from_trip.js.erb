$("#expenses_grid").html("<%= escape_javascript(render partial: 'expenses_list', locals: { expenses: @selected, wishlist: false } ) %>").html_safe;

$('#expense_currency_id').select2();

  $('body').on('change','#expense_currency_id',function(e){
    currency_exchange();
    });

   $('body').on('focusout','#expense_cost',function(e){
   currency_exchange();
    });

  $.getJSON(
        'http://openexchangerates.org/api/latest.json?app_id=10eff371738744b3b3f187281d3f9a06',
        function(data) {
            // Check money.js has finished loading:
            var currency_data = data
            if ( typeof fx !== "undefined" && fx.rates ) {
                fx.rates = data.rates;
                fx.base = data.base;
            } else {
                // If not, apply to fxSetup global:
                var fxSetup = {
                    rates : data.rates,
                    base : data.base
                }
            }
        });

  function currency_exchange() {
     $('#expense_usd_cost').val("")
      var cost = $('#expense_cost').val();
      var currency = $('#expense_currency_id option:selected').text()
      var converted = fx.convert(cost, {from: currency, to: "USD"}).toFixed(2)
      $('#expense_usd_cost').val(converted + " USD")
  }

  var max = 300;

    $('#expense_description').keyup(function () {
      var len = $(this).val().length;
      var char = max - len;
      if (len >= max) {
        $('#charNum').text(char + ' chars left');
        $('#charNum').css('color', 'red');
        $('.new_expense input[type=submit]').attr('disabled','disabled');
      } else {
        $('#charNum').text(char + ' chars left');
        $('#charNum').css('color', 'grey');
        $('.new_expense input[type=submit]').removeAttr('disabled');
      }
    });

    var old_budget = parseFloat($('h5 .best_in_place[data-bip-attribute="budget"]').text().replace(/[A-Za-z$-,]/g, ""))
    var balance = parseFloat($('#balance-field').text().replace(/[A-Za-z$-,]/g, ""))

    $('h5 .best_in_place[data-bip-attribute="budget"]').change(function(e){
      new_budget = (e.target.value) * 1
      var total_spent = old_budget - balance;
      var new_balance = (new_budget - total_spent).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')
      $('#balance-field').text('$' + new_balance)
      var formatted = new_budget.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')
      $('h5 .best_in_place[data-bip-attribute="budget"]').text('$' + formatted)
    })

